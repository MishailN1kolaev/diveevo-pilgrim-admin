<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–µ–Ω—é –û—Ç–µ–ª—è</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #fff);
            --text-color: var(--tg-theme-text-color, #000);
            --button-color: var(--tg-theme-button-color, #2481cc);
            --button-text-color: var(--tg-theme-button-text-color, #fff);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #f5f5f5);
        }
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding-bottom: 80px;
        }
        .header {
            padding: 15px;
            background: var(--secondary-bg);
            font-weight: bold;
            text-align: center;
        }
        .tabs {
            display: flex;
            justify-content: space-around;
            background: var(--bg-color);
            border-bottom: 1px solid #eee;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .tab {
            padding: 15px;
            cursor: pointer;
            flex: 1;
            text-align: center;
            font-weight: 500;
            border-bottom: 2px solid transparent;
        }
        .tab.active {
            border-bottom-color: var(--button-color);
            color: var(--button-color);
        }
        .content {
            display: none;
            padding: 10px;
        }
        .content.active {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .item-card {
            background: var(--secondary-bg);
            border-radius: 10px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .item-img {
            width: 60px;
            height: 60px;
            background: #ddd;
            border-radius: 50%;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .item-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .item-price {
            font-size: 0.9em;
            color: #888;
            margin-bottom: 10px;
        }
        .add-btn {
            background: var(--button-color);
            color: var(--button-text-color);
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        /* Feedback Form */
        .feedback-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
            margin: 0 auto;
        }
        .rating-stars {
            display: flex;
            justify-content: center;
            gap: 10px;
            font-size: 30px;
            cursor: pointer;
        }
        .star.active {
            color: gold;
        }
        textarea {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            resize: none;
            box-sizing: border-box;
        }

        /* Cart Bar */
        .cart-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--secondary-bg);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #ddd;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        .main-btn {
            background: var(--button-color);
            color: var(--button-text-color);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div class="header" id="room-header">–ö–æ–º–Ω–∞—Ç–∞ ...</div>

<div class="tabs">
    <div class="tab active" onclick="switchTab('food')">üçî –ï–¥–∞</div>
    <div class="tab" onclick="switchTab('drinks')">ü•§ –ù–∞–ø–∏—Ç–∫–∏</div>
    <div class="tab" onclick="switchTab('service')">üõé –°–µ—Ä–≤–∏—Å</div>
    <div class="tab" onclick="switchTab('feedback')">‚≠ê –û—Ç–∑—ã–≤</div>
</div>

<!-- Food Tab -->
<div id="food" class="content active"></div>

<!-- Drinks Tab -->
<div id="drinks" class="content"></div>

<!-- Service Tab -->
<div id="service" class="content"></div>

<!-- Feedback Tab -->
<div id="feedback" class="content" style="display: none;">
    <div class="feedback-form">
        <div class="rating-stars" id="stars">
            <span class="star" data-val="1">‚òÖ</span>
            <span class="star" data-val="2">‚òÖ</span>
            <span class="star" data-val="3">‚òÖ</span>
            <span class="star" data-val="4">‚òÖ</span>
            <span class="star" data-val="5">‚òÖ</span>
        </div>
        <textarea id="feedback-text" rows="4" placeholder="–í–∞—à –æ—Ç–∑—ã–≤..."></textarea>
        <button class="main-btn" onclick="sendFeedback()" style="width:100%">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
</div>

<div class="cart-bar" id="cart-bar" style="display: none;">
    <div>
        <div style="font-weight:bold" id="cart-total">0 ‚ÇΩ</div>
        <div style="font-size:0.8em" id="cart-count">0 —Ç–æ–≤–∞—Ä–æ–≤</div>
    </div>
    <button class="main-btn" onclick="sendOrder()">–ó–∞–∫–∞–∑–∞—Ç—å</button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const urlParams = new URLSearchParams(window.location.search);
    const room = urlParams.get('room') || '101';
    document.getElementById('room-header').innerText = `–ö–æ–º–Ω–∞—Ç–∞ ${room}`;

    let menuItems = [];
    const cart = {};
    let currentRating = 0;

    async function fetchMenu() {
        try {
            const res = await fetch('/api/menu');
            if(res.ok) {
                menuItems = await res.json();
                renderItems();
            }
        } catch(e) {
            console.error(e);
            // Fallback mock
            menuItems = [
                 {id:1, name:'–ó–∞–≤—Ç—Ä–∞–∫', price:500, category:'food', description:'–Ø–∏—á–Ω–∏—Ü–∞ –∏ –∫–æ—Ñ–µ'},
                 {id:2, name:'–ö–æ–ª–∞', price:100, category:'drinks', description:'0.5'}
            ];
            renderItems();
        }
    }

    function getIcon(cat) {
        if(cat=='food') return 'üçî';
        if(cat=='drinks') return 'ü•§';
        if(cat=='service') return 'üõé';
        return 'üì¶';
    }

    function renderItems() {
        ['food', 'drinks', 'service'].forEach(cat => {
            const container = document.getElementById(cat);
            container.innerHTML = '';
            const items = menuItems.filter(i => i.category === cat);

            if(items.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #999;">–ü—É—Å—Ç–æ</div>';
                return;
            }

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'item-card';
                div.innerHTML = `
                    <div class="item-img">${getIcon(item.category)}</div>
                    <div class="item-name">${item.name}</div>
                    <div class="item-price">${item.price > 0 ? item.price + ' ‚ÇΩ' : '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ'}</div>
                    <button class="add-btn" onclick="addToCart(${item.id})">–î–æ–±–∞–≤–∏—Ç—å</button>
                `;
                container.appendChild(div);
            });
        });
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.content').forEach(c => {
            c.classList.remove('active');
            c.style.display = 'none';
        });

        const selectedTab = document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`);
        selectedTab.classList.add('active');

        const content = document.getElementById(tabName);
        content.classList.add('active');

        if(tabName === 'feedback') {
            content.style.display = 'block';
        } else {
            content.style.display = 'grid';
        }
    }

    function addToCart(id) {
        const item = menuItems.find(i => i.id === id);
        if (cart[id]) {
            cart[id].qty++;
        } else {
            cart[id] = { ...item, qty: 1 };
        }
        updateCartUI();
        tg.HapticFeedback.impactOccurred('light');
    }

    function updateCartUI() {
        let total = 0;
        let count = 0;
        Object.values(cart).forEach(item => {
            total += item.price * item.qty;
            count += item.qty;
        });

        const cartBar = document.getElementById('cart-bar');
        if (count > 0) {
            cartBar.style.display = 'flex';
            document.getElementById('cart-total').innerText = total + ' ‚ÇΩ';
            document.getElementById('cart-count').innerText = count + ' —Ç–æ–≤–∞—Ä–æ–≤';

            tg.MainButton.setText(`–ó–∞–∫–∞–∑–∞—Ç—å –Ω–∞ ${total} ‚ÇΩ`);
            tg.MainButton.show();
            tg.MainButton.onClick(sendOrder);
        } else {
            cartBar.style.display = 'none';
            tg.MainButton.hide();
        }
    }

    function sendOrder() {
        if (Object.keys(cart).length === 0) return;

        const data = {
            type: 'order',
            room: room,
            items: cart,
            total_price: Object.values(cart).reduce((sum, i) => sum + (i.price * i.qty), 0)
        };
        tg.sendData(JSON.stringify(data));
    }

    // Feedback
    document.querySelectorAll('.star').forEach(star => {
        star.addEventListener('click', function() {
            currentRating = parseInt(this.dataset.val);
            document.querySelectorAll('.star').forEach(s => {
                s.classList.toggle('active', parseInt(s.dataset.val) <= currentRating);
            });
        });
    });

    function sendFeedback() {
        if (currentRating === 0) {
            tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ü–µ–Ω–∫—É!');
            return;
        }
        const text = document.getElementById('feedback-text').value;
        const data = {
            type: 'feedback',
            rating: currentRating,
            text: text
        };
        tg.sendData(JSON.stringify(data));
    }

    fetchMenu();
    switchTab('food');

</script>
</body>
</html>
