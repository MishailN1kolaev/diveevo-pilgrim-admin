<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PMS –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            /* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ –ø–æ –¥–µ—Ñ–æ–ª—Ç—É */
            --bg-color: #ffffff;
            --text-color: #000000;
            --secondary-bg-color: #f5f5f5;
            --hint-color: #999999;
            --button-color: #2481cc;
            --button-text-color: #ffffff;
            --border-color: #dddddd;
        }
        body { font-family: sans-serif; margin: 0; padding-bottom: 50px; background-color: var(--bg-color); color: var(--text-color); font-size: 16px; }
        .tabs { display: flex; border-bottom: 1px solid var(--border-color); background: var(--secondary-bg-color); position: sticky; top: 0; z-index: 10; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; border-bottom: 3px solid transparent; color: var(--text-color); font-size: 16px; }
        .tab.active { border-bottom-color: var(--button-color); color: var(--button-color); font-weight: bold; }

        .content { display: none; padding: 15px; }
        .content.active { display: block; }

        /* Forms */
        .form-card { background: var(--secondary-bg-color); padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; background: #fff; color: var(--text-color); font-size: 16px; }
        button { width: 100%; padding: 12px; background: var(--button-color); color: var(--button-text-color); border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button.delete { background: #ff5252; }

        /* Lists */
        .list-item { background: var(--bg-color); border: 1px solid var(--border-color); padding: 10px; margin-bottom: 10px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .list-info { flex-grow: 1; }

        /* Chessboard Grid */
        .controls { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; }
        .grid-container { display: grid; overflow-x: auto; border: 1px solid var(--border-color); position: relative; }
        .cell { height: 50px; border-right: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: center; font-size: 14px; min-width: 50px; color: var(--text-color); position: relative; }
        .header-cell { background: var(--secondary-bg-color); color: var(--text-color); font-weight: bold; position: sticky; top: 0; z-index: 5; }
        .room-cell { background: var(--secondary-bg-color); color: var(--text-color); font-weight: bold; position: sticky; left: 0; z-index: 6; min-width: 70px; justify-content: flex-start; padding-left: 5px; }

        /* Booking Styles */
        .booking-cell {
            background: var(--button-color);
            color: var(--button-text-color);
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            cursor: pointer;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            position: absolute; /* Changed to absolute to overlay */
            top: 0;
            left: 0;
        }

        /* Split Cell Styles */
        .cell.split-cell {
            display: block; /* reset flex */
        }

        /* Departing: Top-Left Half */
        .booking-cell.departing {
            width: 100%;
            height: 50%;
            top: 0;
            left: 0;
            border-bottom: 1px solid #fff;
            box-sizing: border-box;
            z-index: 2;
            background: #f0ad4e; /* Orangeish for checkout */
        }
        /* Add checkout time indicator */
        .booking-cell.departing::after {
            content: '–í—ã–µ–∑–¥ –¥–æ 12:00';
            position: absolute;
            bottom: 2px;
            right: 5px;
            font-size: 9px;
            opacity: 0.8;
        }

        /* Arriving: Bottom-Right Half */
        .booking-cell.arriving {
            width: 100%;
            height: 50%;
            top: 50%;
            left: 0;
            z-index: 2;
            background: var(--button-color);
        }
        /* Add checkin time indicator */
        .booking-cell.arriving::after {
            content: '–ó–∞–µ–∑–¥ —Å 13:00';
            position: absolute;
            top: 2px;
            right: 5px;
            font-size: 9px;
            opacity: 0.8;
        }

        .booking-cell.cleaning-needed { background: #ffd700; color: #000; } /* Gold/Yellow */
        .booking-cell.cleaned { background: #4caf50; color: #fff; } /* Green */

        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--bg-color); color: var(--text-color); padding: 20px; border-radius: 8px; width: 90%; max-width: 350px; border: 1px solid var(--border-color); max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body>

<div class="tabs">
    <div class="tab active" onclick="showTab('bookings')">üìÖ –ë—Ä–æ–Ω—å</div>
    <div class="tab" onclick="showTab('rooms')">üõè –ù–æ–º–µ—Ä–∞</div>
    <div class="tab" onclick="showTab('menu')">üçî –ú–µ–Ω—é</div>
</div>

<!-- Bookings Tab -->
<div id="bookings" class="content active">
    <div class="controls">
        <button style="width:auto" onclick="changeDate(-7)">‚óÄ</button>
        <input type="date" id="date-picker" style="width: auto; margin: 0 10px;" onchange="jumpToDate(this.value)">
        <button style="width:auto" onclick="changeDate(7)">‚ñ∂</button>
    </div>
    <div id="pms-grid" class="grid-container"></div>
</div>

<!-- Rooms Tab -->
<div id="rooms" class="content">
    <div class="form-card">
        <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä</h3>
        <input type="number" id="room-number" placeholder="–ù–æ–º–µ—Ä (101)">
        <input type="text" id="room-type" placeholder="–¢–∏–ø (–õ—é–∫—Å)">
        <input type="number" id="room-price" placeholder="–¶–µ–Ω–∞ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç)">
        <button onclick="addRoom()">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    <div id="rooms-list"></div>
</div>

<!-- Menu Tab -->
<div id="menu" class="content">
    <div class="form-card">
        <h3>–î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ</h3>
        <input type="text" id="menu-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
        <input type="number" id="menu-price" placeholder="–¶–µ–Ω–∞">
        <select id="menu-category">
            <option value="food">–ï–¥–∞</option>
            <option value="drinks">–ù–∞–ø–∏—Ç–∫–∏</option>
            <option value="service">–°–µ—Ä–≤–∏—Å</option>
        </select>
        <button onclick="addMenuItem()">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    <div id="menu-list"></div>
</div>

<!-- Modals -->
<div id="booking-modal" class="modal">
    <div class="modal-content">
        <h3 id="modal-title">–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
        <input type="hidden" id="b-id">
        <label>–ö–æ–º–Ω–∞—Ç–∞</label>
        <select id="b-room" onchange="updateRoomPrice()"></select>
        <label>–ó–∞–µ–∑–¥</label>
        <input type="date" id="b-checkin" onchange="recalcTotal()">
        <label>–í—ã–µ–∑–¥</label>
        <input type="date" id="b-checkout" onchange="recalcTotal()">
        <label>–ì–æ—Å—Ç—å</label>
        <input type="text" id="b-guest">
        <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
        <input type="tel" id="b-phone" placeholder="+79001234567">
        <label>–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ —Å—É—Ç–∫–∏ (‚ÇΩ)</label>
        <input type="number" id="b-cost-per-night" onchange="recalcTotal()">

        <div style="background: #eee; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
            <div>–ü—Ä–æ–∂–∏–≤–∞–Ω–∏–µ: <b id="calc-room-total">0</b> ‚ÇΩ</div>
            <div>–î–æ–ø. —É—Å–ª—É–≥–∏: <b id="calc-extras-total">0</b> ‚ÇΩ</div>
            <div style="font-size: 1.2em; margin-top: 5px;">–ò—Ç–æ–≥–æ: <b id="calc-total">0</b> ‚ÇΩ</div>
        </div>

        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="delete" id="btn-cancel" onclick="deleteBooking()" style="display:none">–£–¥–∞–ª–∏—Ç—å</button>
            <button onclick="saveBooking()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <button onclick="closeModal()" style="background:#ccc; margin-top:10px">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // State
    let roomsData = [];
    let bookingsData = [];
    let menuData = [];
    let startDate = new Date();
    const daysToShow = 7;

    // Initialization
    async function init() {
        await Promise.all([fetchRooms(), fetchMenu(), fetchBookings()]);
        renderRooms();
        renderMenu();
        renderGrid();
        updateDateHeader();

        // Auto-update
        setInterval(async () => {
             await fetchBookings();
             if(document.getElementById('bookings').classList.contains('active')) {
                 renderGrid();
             }
        }, 5000);
    }

    // API Calls
    async function fetchRooms() {
        const res = await fetch('/api/rooms');
        if(res.ok) roomsData = await res.json();
    }
    async function fetchMenu() {
        const res = await fetch('/api/menu');
        if(res.ok) menuData = await res.json();
    }
    async function fetchBookings() {
        const res = await fetch('/api/bookings');
        if(res.ok) bookingsData = await res.json();
    }

    // --- Tabs ---
    function showTab(id) {
        document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelector(`.tab[onclick="showTab('${id}')"]`).classList.add('active');
    }

    // --- Rooms Management ---
    function renderRooms() {
        const list = document.getElementById('rooms-list');
        list.innerHTML = '';
        roomsData.forEach(r => {
            const div = document.createElement('div');
            div.className = 'list-item';
            div.innerHTML = `
                <div class="list-info"><b>‚Ññ${r.number}</b> - ${r.type} (${r.price}‚ÇΩ)</div>
                <button class="delete" style="width:auto" onclick="deleteRoom(${r.id})">üóë</button>
            `;
            list.appendChild(div);
        });

        // Update modal select
        const sel = document.getElementById('b-room');
        sel.innerHTML = '';
        roomsData.forEach(r => {
            const opt = document.createElement('option');
            opt.value = r.number;
            opt.innerText = r.number;
            sel.appendChild(opt);
        });
    }

    async function addRoom() {
        const number = document.getElementById('room-number').value;
        const type = document.getElementById('room-type').value;
        const price = document.getElementById('room-price').value;
        if(!number || !price) return tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è");

        await fetch('/api/rooms', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({number, type, price})
        });
        document.getElementById('room-number').value = '';
        await fetchRooms();
        renderRooms();
        renderGrid();
    }

    async function deleteRoom(id) {
        if(!confirm("–£–¥–∞–ª–∏—Ç—å –Ω–æ–º–µ—Ä?")) return;
        await fetch('/api/rooms', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({id})
        });
        await fetchRooms();
        renderRooms();
        renderGrid();
    }

    // --- Menu Management ---
    function renderMenu() {
        const list = document.getElementById('menu-list');
        list.innerHTML = '';
        menuData.forEach(m => {
            const div = document.createElement('div');
            div.className = 'list-item';
            div.innerHTML = `
                <div class="list-info"><b>${m.name}</b> (${m.price}‚ÇΩ) <small>${m.category}</small></div>
                <button class="delete" style="width:auto" onclick="deleteMenuItem(${m.id})">üóë</button>
            `;
            list.appendChild(div);
        });
    }

    async function addMenuItem() {
        const name = document.getElementById('menu-name').value;
        const price = document.getElementById('menu-price').value;
        const category = document.getElementById('menu-category').value;
        if(!name || !price) return tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è");

        await fetch('/api/menu', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name, price, category})
        });
        document.getElementById('menu-name').value = '';
        await fetchMenu();
        renderMenu();
    }

    async function deleteMenuItem(id) {
        if(!confirm("–£–¥–∞–ª–∏—Ç—å –±–ª—é–¥–æ?")) return;
        await fetch('/api/menu', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({id})
        });
        await fetchMenu();
        renderMenu();
    }

    // --- Calendar Grid ---
    function changeDate(days) {
        startDate.setDate(startDate.getDate() + days);
        renderGrid();
        updateDateHeader();
    }

    function jumpToDate(val) {
        if (!val) return;
        startDate = new Date(val);
        renderGrid();
        updateDateHeader();
    }

    function updateDateHeader() {
        const dateInput = document.getElementById('date-picker');
        const yyyy = startDate.getFullYear();
        const mm = String(startDate.getMonth() + 1).padStart(2, '0');
        const dd = String(startDate.getDate()).padStart(2, '0');
        dateInput.value = `${yyyy}-${mm}-${dd}`;
    }

    function renderGrid() {
        const grid = document.getElementById('pms-grid');
        const scrollLeft = grid.scrollLeft;
        grid.innerHTML = '';

        // Layout
        grid.style.gridTemplateColumns = `70px repeat(${daysToShow}, 1fr)`;

        // Dates Header
        grid.appendChild(createCell('‚Ññ', 'header-cell room-cell'));
        for(let i=0; i<daysToShow; i++) {
            const d = new Date(startDate);
            d.setDate(d.getDate() + i);
            const cell = createCell(`${d.getDate()}.${d.getMonth()+1}`, 'header-cell');
            grid.appendChild(cell);
        }

        // Booking Map: room_date -> [bookings]
        // Support multiple bookings per day
        const bookingMap = {};

        bookingsData.forEach(b => {
            const start = new Date(b.check_in);
            const end = new Date(b.check_out);
            let curr = new Date(start);

            while(curr <= end) {
                const dStr = curr.toISOString().split('T')[0];
                const key = `${b.room_number}_${dStr}`;

                if(!bookingMap[key]) bookingMap[key] = [];

                const isStart = (curr.getTime() === start.getTime());
                const isEnd = (curr.getTime() === end.getTime());

                bookingMap[key].push({
                    booking: b,
                    isStart: isStart,
                    isEnd: isEnd
                });

                curr.setDate(curr.getDate() + 1);
            }
        });

        roomsData.forEach(room => {
            grid.appendChild(createCell(room.number, 'room-cell'));

            for(let i=0; i<daysToShow; i++) {
                const d = new Date(startDate);
                d.setDate(d.getDate() + i);
                const dateStr = d.toISOString().split('T')[0];
                const cell = createCell('', 'cell');

                const key = `${room.number}_${dateStr}`;
                const bookings = bookingMap[key] || [];

                // Render Logic for Split vs Full
                // Case 1: Single booking, full day (middle)
                // Case 2: Single booking, Start (PM checkin)
                // Case 3: Single booking, End (AM checkout)
                // Case 4: Overlap (End of A, Start of B)

                // To simplify, we just render divs.
                // If "Full Day", we use width 100%, height 100%.
                // If "End", we use Top Half? Or standard cleaning view.
                // If "Start", we use Bottom Half?

                // Actually, let's use simple heuristics:
                // If we have >1 booking, assume it's a transition day.
                // Find the one ending today and the one starting today.

                const ending = bookings.find(x => x.isEnd);
                const starting = bookings.find(x => x.isStart);
                const ongoing = bookings.find(x => !x.isStart && !x.isEnd);

                if (ongoing) {
                    // Full day occupation
                    cell.appendChild(createBookingDiv(ongoing.booking, 'full'));
                } else if (ending && starting) {
                    // Transition
                    cell.classList.add('split-cell');
                    cell.appendChild(createBookingDiv(ending.booking, 'departing', true));
                    cell.appendChild(createBookingDiv(starting.booking, 'arriving'));
                } else if (ending) {
                    // Only ending (checkout day)
                    // Normally this is a cleaning day.
                    // We can show it as departing/cleaning.
                    // Visually, let's make it full cell but mark as 'departing' style or just standard 'cleaning-needed'
                    // If we use 'departing' style (half height), it implies availability in PM.
                    // Let's use half-height to indicate PM is free?
                    // Or stick to old logic if no new guest.
                    // Requirement: "show checkout was 12 and checkin is 13".
                    // So let's use half-height for ending bookings on the last day.
                    cell.appendChild(createBookingDiv(ending.booking, 'departing', true));
                } else if (starting) {
                    // Only starting (checkin day)
                    cell.appendChild(createBookingDiv(starting.booking, 'arriving'));
                } else {
                    // Empty
                    cell.onclick = () => openModal(null, room.number, dateStr);
                }

                grid.appendChild(cell);
            }
        });

        grid.scrollLeft = scrollLeft;
    }

    function createBookingDiv(booking, type, isCleaningLogic=false) {
        const div = document.createElement('div');
        div.className = 'booking-cell';
        div.innerText = booking.guest_name;

        if (type === 'departing') {
            div.classList.add('departing');
            // Cleaning Logic
             div.classList.add('cleaning-needed');
             if (booking.is_cleaned) {
                 div.classList.remove('cleaning-needed');
                 div.classList.add('cleaned');
             }
             div.onclick = async (e) => {
                 e.stopPropagation();
                 await fetch('/api/bookings/toggle_cleaning', {
                     method: 'POST',
                     headers: {'Content-Type': 'application/json'},
                     body: JSON.stringify({id: booking.id})
                 });
                 await fetchBookings();
                 renderGrid();
             };
        } else if (type === 'arriving') {
            div.classList.add('arriving');
            div.onclick = (e) => { e.stopPropagation(); openModal(booking); };
        } else {
            // Full
            div.onclick = (e) => { e.stopPropagation(); openModal(booking); };
        }

        return div;
    }

    function createCell(text, className) {
        const div = document.createElement('div');
        div.className = 'cell ' + className;
        div.innerText = text;
        return div;
    }


    // --- Modal & Booking Actions ---
    function updateRoomPrice() {
        const roomNum = document.getElementById('b-room').value;
        const room = roomsData.find(r => r.number == roomNum);
        if (room) {
            if (!document.getElementById('b-id').value) {
                document.getElementById('b-cost-per-night').value = room.price;
                recalcTotal();
            }
        }
    }

    function recalcTotal() {
        const checkIn = new Date(document.getElementById('b-checkin').value);
        const checkOut = new Date(document.getElementById('b-checkout').value);
        const costPerNight = parseFloat(document.getElementById('b-cost-per-night').value) || 0;

        let nights = 0;
        if (checkIn && checkOut && checkOut > checkIn) {
            const diff = checkOut - checkIn;
            nights = Math.ceil(diff / (1000 * 60 * 60 * 24));
        }

        const roomTotal = nights * costPerNight;

        let extras = 0;
        const id = document.getElementById('b-id').value;
        if (id) {
            const booking = bookingsData.find(b => b.id == id);
            if (booking) extras = booking.extras_total || 0;
        }

        document.getElementById('calc-room-total').innerText = roomTotal;
        document.getElementById('calc-extras-total').innerText = extras;
        document.getElementById('calc-total').innerText = roomTotal + extras;
    }

    function openModal(booking, roomNum, dateStr) {
        const modal = document.getElementById('booking-modal');
        const btnCancel = document.getElementById('btn-cancel');

        if (booking) {
            document.getElementById('modal-title').innerText = "–ë—Ä–æ–Ω—å #" + booking.id;
            document.getElementById('b-id').value = booking.id;
            document.getElementById('b-room').value = booking.room_number;
            document.getElementById('b-checkin').value = booking.check_in;
            document.getElementById('b-checkout').value = booking.check_out;
            document.getElementById('b-guest').value = booking.guest_name;
            document.getElementById('b-phone').value = booking.phone || '';
            document.getElementById('b-cost-per-night').value = booking.cost_per_night || 0;

            btnCancel.style.display = 'block';
        } else {
            document.getElementById('modal-title').innerText = "–ù–æ–≤–∞—è –±—Ä–æ–Ω—å";
            document.getElementById('b-id').value = '';
            document.getElementById('b-room').value = roomNum;
            document.getElementById('b-checkin').value = dateStr;

            const next = new Date(dateStr);
            next.setDate(next.getDate()+1);
            document.getElementById('b-checkout').value = next.toISOString().split('T')[0];

            document.getElementById('b-guest').value = '';
            document.getElementById('b-phone').value = '';

            const room = roomsData.find(r => r.number == roomNum);
            document.getElementById('b-cost-per-night').value = room ? room.price : 0;

            btnCancel.style.display = 'none';
        }
        recalcTotal();
        modal.classList.add('active');
    }

    function closeModal() {
        document.getElementById('booking-modal').classList.remove('active');
    }

    async function saveBooking() {
        const id = document.getElementById('b-id').value;
        const room_number = document.getElementById('b-room').value;
        const check_in = document.getElementById('b-checkin').value;
        const check_out = document.getElementById('b-checkout').value;
        const guest_name = document.getElementById('b-guest').value;
        const phone = document.getElementById('b-phone').value;
        const cost_per_night = parseFloat(document.getElementById('b-cost-per-night').value) || 0;

        if(!guest_name) return tg.showAlert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –≥–æ—Å—Ç—è");

        if (id) {
             alert("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: —É–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—É—é –∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é (–¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –Ω—É–∂–Ω–æ API –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)");
             return;
        }

        const res = await fetch('/api/bookings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                room_number,
                guest_name,
                check_in,
                check_out,
                cost_per_night,
                phone
            })
        });

        if(res.ok) {
            closeModal();
            fetchBookings().then(renderGrid);
        } else {
            alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
        }
    }

    async function deleteBooking() {
        const id = document.getElementById('b-id').value;
        if(!confirm("–£–¥–∞–ª–∏—Ç—å –±—Ä–æ–Ω—å?")) return;

        await fetch('/api/bookings', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({id})
        });
        closeModal();
        fetchBookings().then(renderGrid);
    }

    // Start
    init();

</script>
</body>
</html>
